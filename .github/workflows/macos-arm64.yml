name: macOS ARM64

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

jobs:
  build-and-test:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install LLVM
        run: brew install llvm
      - name: Verify compiler
        run: |
          LLVM_CC="$(brew --prefix llvm)/bin/clang"
          echo "Using: ${LLVM_CC}"
          ${LLVM_CC} --version
      - name: Debug env
        run: |
          echo "CFLAGS=$CFLAGS"
          echo "CPPFLAGS=$CPPFLAGS"
          echo "LDFLAGS=$LDFLAGS"
          echo "MOREFLAGS=$MOREFLAGS"
          echo "--- clang config ---"
          cat /opt/homebrew/etc/clang/arm64-apple-darwin*.cfg 2>/dev/null || echo "no system config"
          cat ~/.config/clang/arm64-apple-darwin*.cfg 2>/dev/null || echo "no user config"
          echo "--- SDK ---"
          xcrun --show-sdk-path 2>/dev/null || echo "no xcrun"
          sw_vers
          echo "--- clang verbose ---"
          $(brew --prefix llvm)/bin/clang -v -mcpu=apple-m1 -E - < /dev/null 2>&1 | head -20
      - name: Build
        run: make V=1 CC="$(brew --prefix llvm)/bin/clang" MOREFLAGS="-mcpu=apple-m1"
      - name: Check
        run: make check CC="$(brew --prefix llvm)/bin/clang" MOREFLAGS="-mcpu=apple-m1"
      - name: Prepare artifact
        run: |
          mkdir -p artifact
          cp programs/zstd artifact/zstd-vk
          cp programs/zstd.1 artifact/zstd-vk.1
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: zstd-vk-macos-arm64
          path: artifact/

  bottle:
    if: github.event_name == 'release'
    runs-on: macos-latest
    needs: build-and-test
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Install LLVM
        run: brew install llvm

      - name: Build zstd
        run: make CC="$(brew --prefix llvm)/bin/clang" MOREFLAGS="-mcpu=apple-m1"

      - name: Package bottle
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          PREFIX="$(pwd)/bottle/zstd-vk/${VERSION}"

          mkdir -p "${PREFIX}/bin" "${PREFIX}/share/man/man1"
          cp programs/zstd "${PREFIX}/bin/zstd-vk"
          cp programs/zstd.1 "${PREFIX}/share/man/man1/zstd-vk.1"

          # Detect macOS version for bottle tag
          OS_VERSION=$(sw_vers -productVersion | cut -d. -f1)
          case "${OS_VERSION}" in
            15) BOTTLE_TAG="arm64_sequoia" ;;
            14) BOTTLE_TAG="arm64_sonoma" ;;
            13) BOTTLE_TAG="arm64_ventura" ;;
            *)  BOTTLE_TAG="arm64_sonoma" ;;
          esac

          BOTTLE_NAME="zstd-vk--${VERSION}.${BOTTLE_TAG}.bottle.tar.gz"
          tar -czf "${BOTTLE_NAME}" -C bottle zstd-vk
          echo "BOTTLE_NAME=${BOTTLE_NAME}" >> "$GITHUB_ENV"
          echo "BOTTLE_TAG=${BOTTLE_TAG}" >> "$GITHUB_ENV"
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"

          SHA256=$(shasum -a 256 "${BOTTLE_NAME}" | cut -d' ' -f1)
          echo "BOTTLE_SHA256=${SHA256}" >> "$GITHUB_ENV"

          # Compute source tarball SHA256 for the formula
          SOURCE_URL="https://github.com/vibekernels/zstd-vk-macos-arm64/archive/refs/tags/${GITHUB_REF_NAME}.tar.gz"
          SOURCE_SHA256=$(curl -sL "${SOURCE_URL}" | shasum -a 256 | cut -d' ' -f1)
          echo "SOURCE_SHA256=${SOURCE_SHA256}" >> "$GITHUB_ENV"

      - name: Upload bottle to release
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh release upload "${GITHUB_REF_NAME}" "${BOTTLE_NAME}"

      - name: Update homebrew-tap formula
        env:
          TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          if [ -z "${TAP_TOKEN}" ]; then
            echo "::warning::HOMEBREW_TAP_TOKEN secret not set, skipping tap update"
            echo ""
            echo "=========================================="
            echo "Add this to Formula/zstd-vk.rb manually:"
            echo "=========================================="
            echo ""
            echo "  bottle do"
            echo "    root_url \"https://github.com/vibekernels/zstd-vk-macos-arm64/releases/download/${GITHUB_REF_NAME}\""
            echo "    sha256 cellar: :any_skip_relocation, ${BOTTLE_TAG}: \"${BOTTLE_SHA256}\""
            echo "  end"
            exit 0
          fi

          git clone "https://x-access-token:${TAP_TOKEN}@github.com/vibekernels/homebrew-tap.git" tap
          cd tap

          cat > Formula/zstd-vk.rb << 'FORMULA'
          class ZstdVk < Formula
            desc "ARM64-optimized Zstandard compression for Apple Silicon"
            homepage "https://github.com/vibekernels/zstd-vk-macos-arm64"
          FORMULA

          # Write lines that need variable interpolation
          cat >> Formula/zstd-vk.rb << EOF
            url "https://github.com/vibekernels/zstd-vk-macos-arm64/archive/refs/tags/${GITHUB_REF_NAME}.tar.gz"
            sha256 "${SOURCE_SHA256}"
          EOF

          cat >> Formula/zstd-vk.rb << 'FORMULA'
            license "BSD-2-Clause"
          FORMULA

          cat >> Formula/zstd-vk.rb << EOF
            head "https://github.com/vibekernels/zstd-vk-macos-arm64.git", branch: "main"

            bottle do
              root_url "https://github.com/vibekernels/zstd-vk-macos-arm64/releases/download/${GITHUB_REF_NAME}"
              sha256 cellar: :any_skip_relocation, ${BOTTLE_TAG}: "${BOTTLE_SHA256}"
            end
          EOF

          cat >> Formula/zstd-vk.rb << 'FORMULA'

            depends_on "llvm" => :build

            def install
              llvm = Formula["llvm"]
              system "make", "-C", "programs", "zstd-release",
                     "CC=#{llvm.opt_bin}/clang",
                     "MOREFLAGS=-mcpu=apple-m1",
                     "PREFIX=#{prefix}"

              bin.install "programs/zstd" => "zstd-vk"
              man1.install "programs/zstd.1" => "zstd-vk.1"
            end

            test do
              (testpath/"input.txt").write("Hello, World!" * 100)
              system bin/"zstd-vk", "input.txt"
              assert_path_exists testpath/"input.txt.zst"
              system bin/"zstd-vk", "-d", "input.txt.zst", "-o", "output.txt"
              assert_equal (testpath/"input.txt").read, (testpath/"output.txt").read
            end
          end
          FORMULA

          # Fix indentation (heredocs add leading spaces)
          sed -i '' 's/^          //' Formula/zstd-vk.rb

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/zstd-vk.rb
          git commit -m "Update zstd-vk to ${GITHUB_REF_NAME}"
          git push
